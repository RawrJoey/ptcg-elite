{"version":3,"file":"/Users/joemyerscough/Documents/GitHub/ptcg-epsd/ptcg-server/src/game/store/reducers/player-turn-reducer.ts","sources":["/Users/joemyerscough/Documents/GitHub/ptcg-epsd/ptcg-server/src/game/store/reducers/player-turn-reducer.ts"],"names":[],"mappings":"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","sourcesContent":["import { Action } from '../actions/action';\nimport { PassTurnAction, RetreatAction, AttackAction, UseAbilityAction, UseStadiumAction } from '../actions/game-actions';\nimport { State, GamePhase } from '../state/state';\nimport { StoreLike } from '../store-like';\nimport { GameError } from '../../game-error';\nimport { GameMessage } from '../../game-message';\nimport { RetreatEffect, UseAttackEffect, UsePowerEffect, UseStadiumEffect } from '../effects/game-effects';\nimport { EndTurnEffect } from '../effects/game-phase-effects';\nimport { StateUtils } from '../state-utils';\nimport {SlotType} from '../actions/play-card-action';\nimport {PokemonCard} from '../card/pokemon-card';\n\nexport function playerTurnReducer(store: StoreLike, state: State, action: Action): State {\n\n  if (state.phase === GamePhase.PLAYER_TURN) {\n\n    if (action instanceof PassTurnAction) {\n      const player = state.players[state.activePlayer];\n\n      if (player === undefined || player.id !== action.clientId) {\n        throw new GameError(GameMessage.NOT_YOUR_TURN);\n      }\n\n      const endTurnEffect = new EndTurnEffect(player);\n\n      state = store.reduceEffect(state, endTurnEffect);\n      return state;\n    }\n\n    if (action instanceof RetreatAction) {\n      const player = state.players[state.activePlayer];\n\n      if (player === undefined || player.id !== action.clientId) {\n        throw new GameError(GameMessage.NOT_YOUR_TURN);\n      }\n\n      const retreatEffect = new RetreatEffect(player, action.benchIndex);\n      state = store.reduceEffect(state, retreatEffect);\n      return state;\n    }\n\n    if (action instanceof AttackAction) {\n      const player = state.players[state.activePlayer];\n\n      if (player === undefined || player.id !== action.clientId) {\n        throw new GameError(GameMessage.NOT_YOUR_TURN);\n      }\n\n      const pokemonCard = player.active.getPokemonCard();\n      if (pokemonCard === undefined) {\n        throw new GameError(GameMessage.UNKNOWN_ATTACK);\n      }\n\n      const attack = pokemonCard.attacks.find(a => a.name === action.name);\n      if (attack === undefined) {\n        throw new GameError(GameMessage.UNKNOWN_ATTACK);\n      }\n\n      const useAttackEffect = new UseAttackEffect(player, attack);\n      state = store.reduceEffect(state, useAttackEffect);\n      return state;\n    }\n\n    if (action instanceof UseAbilityAction) {\n      const player = state.players[state.activePlayer];\n\n      if (player === undefined || player.id !== action.clientId) {\n        throw new GameError(GameMessage.NOT_YOUR_TURN);\n      }\n\n      let pokemonCard: PokemonCard | undefined;\n\n      switch (action.target.slot) {\n        case SlotType.ACTIVE:\n        case SlotType.BENCH: {\n          const target = StateUtils.getTarget(state, player, action.target);\n          pokemonCard = target.getPokemonCard();\n          break;\n        }\n        case SlotType.DISCARD: {\n          const discardCard = player.discard.cards[action.target.index];\n          if (discardCard instanceof PokemonCard) {\n            pokemonCard = discardCard;\n          }\n          break;\n        }\n        case SlotType.HAND: {\n          const handCard = player.hand.cards[action.target.index];\n          if (handCard instanceof PokemonCard) {\n            pokemonCard = handCard;\n          }\n          break;\n        }\n      }\n\n      if (pokemonCard === undefined) {\n        throw new GameError(GameMessage.INVALID_TARGET);\n      }\n\n      const power = pokemonCard.powers.find(a => a.name === action.name);\n      if (power === undefined) {\n        throw new GameError(GameMessage.UNKNOWN_POWER);\n      }\n\n      const slot = action.target.slot;\n      if (slot === SlotType.ACTIVE || slot === SlotType.BENCH) {\n        if (!power.useWhenInPlay) {\n          throw new GameError(GameMessage.CANNOT_USE_POWER);\n        }\n      }\n\n      if (slot === SlotType.HAND && !power.useFromHand) {\n        throw new GameError(GameMessage.CANNOT_USE_POWER);\n      }\n\n      if (slot === SlotType.DISCARD && !power.useFromDiscard) {\n        throw new GameError(GameMessage.CANNOT_USE_POWER);\n      }\n\n      state = store.reduceEffect(state, new UsePowerEffect(player, power, pokemonCard));\n      return state;\n    }\n\n    if (action instanceof UseStadiumAction) {\n      const player = state.players[state.activePlayer];\n\n      if (player === undefined || player.id !== action.clientId) {\n        throw new GameError(GameMessage.NOT_YOUR_TURN);\n      }\n\n      if (player.stadiumUsedTurn === state.turn) {\n        throw new GameError(GameMessage.STADIUM_ALREADY_USED);\n      }\n\n      const stadium = StateUtils.getStadiumCard(state);\n      if (stadium === undefined) {\n        throw new GameError(GameMessage.NO_STADIUM_IN_PLAY);\n      }\n\n      state = store.reduceEffect(state, new UseStadiumEffect(player, stadium));\n      return state;\n    }\n\n  }\n\n  return state;\n}\n"]}