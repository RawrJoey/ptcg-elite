{"version":3,"file":"/Users/joemyerscough/Documents/GitHub/ptcg-epsd/ptcg-server/src/game/store/effect-reducers/retreat-effect.ts","sources":["/Users/joemyerscough/Documents/GitHub/ptcg-epsd/ptcg-server/src/game/store/effect-reducers/retreat-effect.ts"],"names":[],"mappings":"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","sourcesContent":["import { ChooseEnergyPrompt } from '../prompts/choose-energy-prompt';\nimport { GameError } from '../../game-error';\nimport { GameMessage, GameLog } from '../../game-message';\nimport { Effect } from '../effects/effect';\nimport { State } from '../state/state';\nimport { StoreLike } from '../store-like';\nimport { RetreatEffect } from '../effects/game-effects';\nimport { StateUtils } from '../state-utils';\nimport { CheckRetreatCostEffect, CheckProvidedEnergyEffect } from '../effects/check-effects';\nimport { SpecialCondition } from '../card/card-types';\n\n\nfunction retreatPokemon(store: StoreLike, state: State, effect: RetreatEffect) {\n  const player = effect.player;\n  const activePokemon = player.active.getPokemonCard();\n  const benchedPokemon = player.bench[effect.benchIndex].getPokemonCard();\n  if (activePokemon === undefined || benchedPokemon === undefined) {\n    return;\n  }\n\n  store.log(state, GameLog.LOG_PLAYER_RETREATS, {\n    name: player.name,\n    active: activePokemon.name,\n    benched: benchedPokemon.name\n  });\n  player.retreatedTurn = state.turn;\n  player.switchPokemon(player.bench[effect.benchIndex]);\n}\n\nexport function retreatReducer(store: StoreLike, state: State, effect: Effect): State {\n\n  /* Retreat pokemon */\n  if (effect instanceof RetreatEffect) {\n    const player = effect.player;\n\n    if (player.bench[effect.benchIndex].cards.length === 0) {\n      throw new GameError(GameMessage.INVALID_TARGET);\n    }\n\n    const sp = player.active.specialConditions;\n    if (sp.includes(SpecialCondition.PARALYZED) || sp.includes(SpecialCondition.ASLEEP)) {\n      throw new GameError(GameMessage.BLOCKED_BY_SPECIAL_CONDITION);\n    }\n\n    if (player.retreatedTurn === state.turn) {\n      throw new GameError(GameMessage.RETREAT_ALREADY_USED);\n    }\n\n    const checkRetreatCost = new CheckRetreatCostEffect(effect.player);\n    state = store.reduceEffect(state, checkRetreatCost);\n\n    if (checkRetreatCost.cost.length === 0) {\n      retreatPokemon(store, state, effect);\n      return state;\n    }\n\n    const checkProvidedEnergy = new CheckProvidedEnergyEffect(player);\n    state = store.reduceEffect(state, checkProvidedEnergy);\n\n    const enoughEnergies = StateUtils.checkEnoughEnergy(checkProvidedEnergy.energyMap, checkRetreatCost.cost);\n    if (enoughEnergies === false) {\n      throw new GameError(GameMessage.NOT_ENOUGH_ENERGY);\n    }\n\n    return store.prompt(state, new ChooseEnergyPrompt(\n      player.id,\n      GameMessage.CHOOSE_POKEMON_TO_SWITCH,\n      checkProvidedEnergy.energyMap,\n      checkRetreatCost.cost\n    ), energy => {\n      if (energy === null) {\n        return; // operation cancelled\n      }\n      const activePokemon = player.active.getPokemonCard();\n      const benchedPokemon = player.bench[effect.benchIndex].getPokemonCard();\n      if (activePokemon === undefined || benchedPokemon === undefined) {\n        return;\n      }\n\n      const cards = energy.map(e => e.card);\n      player.active.moveCardsTo(cards, player.discard);\n      retreatPokemon(store, state, effect);\n    });\n  }\n\n  return state;\n}\n"]}